image: maven:3-jdk-8-slim

stages:
  - docker
  - mirror
  - deploy

.default_cache: &default_cache
  key: ${CI_COMMIT_REF_SLUG}
  paths:
    - .m2/repository/
    - target

build_docker:
  image: docker:19.03.1
  stage: docker
  cache:
    << : *default_cache
    policy: pull
  services:
  - docker:19.03.5-dind 
  script:
  - export TOR_VERSION=$(cat .tor-version)
  - docker login -u $DOCKERHUB_USER -p $DOCKERHUB_PASSWORD $DOCKERHUB_REGISTRY
  - docker pull $DOCKERHUB_REGISTRY_IMAGE:latest || true
  - >
    docker build --pull
    --tag $DOCKERHUB_REGISTRY_IMAGE:$TOR_VERSION
    --cache-from $DOCKERHUB_REGISTRY_IMAGE:latest --build-arg TORVERSION=$TOR_VERSION .
  - docker push $DOCKERHUB_REGISTRY_IMAGE:$TOR_VERSION
  - >
    if [ "$CI_COMMIT_REF_SLUG" == "master" ]; then
      docker tag $DOCKERHUB_REGISTRY_IMAGE:$TOR_VERSION $DOCKERHUB_REGISTRY_IMAGE:latest
      docker push $DOCKERHUB_REGISTRY_IMAGE:latest
    fi
  except:
  - tags

  
mirror_github:
  image: docker:latest
  stage: mirror
  services:
  - docker:dind
  script:
  - export RELEASE_VERSION=$(cat .next-version)
  - export TOR_VERSION=$(cat .tor-version)
  - docker login -u $DOCKERHUB_USER -p $DOCKERHUB_PASSWORD $DOCKERHUB_REGISTRY
  - docker pull $DOCKERHUB_REGISTRY_IMAGE:$TOR_VERSION || true
  - docker login -u $GITHUBUSER -p ${GITHUBTOKEN} ghcr.io
  - docker tag $DOCKERHUB_REGISTRY_IMAGE:$TOR_VERSION $GITHUB_REGISTRY_IMAGE:$TOR_VERSION 
  - docker push $GITHUB_REGISTRY_IMAGE:$TOR_VERSION
  - >
    if [ "$CI_COMMIT_REF_SLUG" == "master" ]; then
      docker tag $GITHUB_REGISTRY_IMAGE:$RELEASE_VERSION $GITHUB_REGISTRY_IMAGE:latest
      docker push $GITHUB_REGISTRY_IMAGE:latest
    fi
  - >
    if [ "$CI_COMMIT_REF_SLUG" == "master" ]; then
      docker tag $GITHUB_REGISTRY_IMAGE:$RELEASE_VERSION $GITHUB_REGISTRY_IMAGE:$TOR_VERSION
      docker push $GITHUB_REGISTRY_IMAGE:$TOR_VERSION
    fi

upload_chart_ftp:
  stage: deploy
  image: alpine
  variables:
    HELM_EXPERIMENTAL_OCI: 1  
  before_script:
  - apk --no-cache add curl openssl bash git
  - curl https://raw.githubusercontent.com/helm/helm/master/scripts/get-helm-3 | bash
  script:
    - export RELEASE_VERSION=1.0.0
    - cd chart && helm package .
    - git clone "https://$GITHUBUSER:$GITHUBTOKEN@github.com/JFWenisch/charts.git" /charts
    - git config --global user.name "Jean-Fabian Wenisch"
    - git config --global user.email "dev@jfwenisch.com"
    - mv alpine-tor-$RELEASE_VERSION.tgz /charts/alpine-tor/alpine-tor-$RELEASE_VERSION.tgz
    - cd /charts
    - git add --all
    - git commit -m "Adding alpine-tor $RELEASE_VERSION" alpine-tor-$RELEASE_VERSION.tgz
    - git push origin master



